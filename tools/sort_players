#!/usr/bin/env python3

import sys
import shutil
from datetime import datetime

def add_password_field(entry):
    lines = entry.split('\n')
    first_line = lines[0].split('/')
    if len(first_line) == 5:  # No password field
        first_line.insert(2, '')  # Add empty password field
    lines[0] = '/'.join(first_line)
    return '\n'.join(lines)

def process_file(filename):
    with open(filename, 'r') as file:
        content = file.read()

    parts = content.split('\n\n')
    description = parts[0]
    user_entries = parts[1:-1]  # Exclude description and END
    end = parts[-1]

    # Add password field and sort user entries
    user_entries = [add_password_field(entry) for entry in user_entries]
    user_entries.sort(key=lambda x: x.split('/')[0].lower())

    # Backup original file
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    backup_filename = f"{filename}.{timestamp}.bak"
    shutil.copy2(filename, backup_filename)

    # Write processed data back to file
    with open(filename, 'w') as file:
        file.write(description + '\n\n')
        file.write('\n\n'.join(user_entries))
        file.write('\n\n' + end)

    print(f"File processed successfully. Backup created: {backup_filename}")

def main():
    if len(sys.argv) != 2:
        print("Usage: python script.py <filename>")
        sys.exit(1)

    filename = sys.argv[1]
    process_file(filename)

if __name__ == "__main__":
    main()
